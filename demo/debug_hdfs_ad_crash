
import sys
import time
sys.path.append('..')
import polars as pl
import loglead.loader as load, loglead.enhancer as er, loglead.anomaly_detection as ad
full_data = "/home/ubuntu/Datasets"
private_data ="../private_data"

loader = load.HDFSLoader(filename=f"{full_data}/hdfs/HDFS.log", 
                                            labels_file_name=f"{full_data}/hdfs/anomaly_label.csv")
loader.execute()
df = loader.reduce_dataframes(0.45)#0.45 works 0.5 does not
import resource
print('Memory usage: %s (kb)' % resource.getrusage(resource.RUSAGE_SELF).ru_maxrss)
df = loader.df
df_seq =  loader.df_sequences
enhancer = er.EventLogEnhancer(df)
#df = enhancer.normalize()
df = enhancer.words()
#df = df.select("seq_id", "e_words")
seq_enhancer = er.SequenceEnhancer(df = df, df_sequences = df_seq)
seq_enhancer.tokens("e_words")
seq_enhancer.df.estimated_size('mb')
seq_enhancer.df_sequences.estimated_size('mb')


#https://github.com/pola-rs/polars/issues/8188

import sys
import psutil
# Get memory details
memory = psutil.virtual_memory()
# Available memory
available_memory_gb = memory.available / (1024 ** 3)  # Convert bytes to gigabytes
print(f"Available Memory: {available_memory_gb:.2f} GB")

seq_enhancer.df.estimated_size('mb')
seq_enhancer.df_sequences.estimated_size('mb')
df.estimated_size('mb')
loader.df.estimated_size('mb')


df = df.drop("m_message")
df = df.select("seq_id", "e_words")